name: Inverter Control Scheduler

on:
  # This allows you to run the workflow manually from the Actions tab for testing
  workflow_dispatch:

  schedule:
    # IMPORTANT: Times are in UTC. Thailand is UTC+7.

    # Schedule for "Set to Solar Mode" at 05:00 Thai time
    # 05:00 Bangkok (UTC+7) is 22:00 UTC on the *previous* day.
    - cron: '0 22 * * *'

    # Schedule for "Set to SBU Mode" at 17:45 (5:45 PM) Thai time
    # 17:45 Bangkok (UTC+7) is 10:45 UTC on the *same* day.
    - cron: '45 10 * * *'

    # Schedule for "Read Status" at the top of every hour
    - cron: '0 * * * *'

jobs:
  run-scheduled-task:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      # Determine which task to run based on the scheduled cron time
      - name: Set Solar Mode (05:00 Bangkok Time)
        if: github.event.schedule == '0 22 * * *'
        env:
          INVERTER_TOKEN: ${{ secrets.INVERTER_TOKEN }}
        run: python inverter_control.py set-solar

      - name: Set SBU Mode (17:45 Bangkok Time)
        if: github.event.schedule == '45 10 * * *'
        env:
          INVERTER_TOKEN: ${{ secrets.INVERTER_TOKEN }}
        run: python inverter_control.py set-sbu

      - name: Read Status (Hourly)
        if: github.event.schedule == '0 * * * *'
        env:
          INVERTER_TOKEN: ${{ secrets.INVERTER_TOKEN }}
        run: python inverter_control.py read-status
