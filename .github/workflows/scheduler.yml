name: Inverter Control Scheduler

on:
  workflow_dispatch:
  schedule:
    # These triggers wake up the workflow at the required times.
    # The logic to decide which action to run is inside the job itself.
    - cron: '0 22 * * *'    # Trigger for 05:00 Bangkok time
    - cron: '45 10 * * *'   # Trigger for 17:45 Bangkok time
    - cron: '0 * * * *'     # Trigger for hourly status check

jobs:
  run-scheduled-task:
    runs-on: ubuntu-latest
    steps:
      - name: Get current date and time in UTC
        id: date
        run: |
          echo "day=$(date -u +'%d')" >> $GITHUB_OUTPUT
          echo "hour=$(date -u +'%H')" >> $GITHUB_OUTPUT
          echo "minute=$(date -u +'%M')" >> $GITHUB_OUTPUT

      - name: Check if today is an automation day
        id: check_day
        run: |
          day=$((10#${{ steps.date.outputs.day }}))
          echo "Today is day $day of the month (UTC)."
          if (( (day >= 1 && day <= 22) || (day >= 27 && day <= 31) )); then
            echo "Automation is ENABLED today."
            echo "run_today=true" >> $GITHUB_OUTPUT
          else
            echo "Automation is SKIPPED today (days 23-26)."
            echo "run_today=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      - name: Set Solar Mode (05:00 Bangkok Time = 22:00 UTC)
        if: steps.check_day.outputs.run_today == 'true' && steps.date.outputs.hour == '22' && steps.date.outputs.minute == '00'
        env:
          INVERTER_TOKEN: ${{ secrets.INVERTER_TOKEN }}
        run: python inverter_control.py set-solar

      - name: Set SBU Mode (17:45 Bangkok Time = 10:45 UTC)
        if: steps.check_day.outputs.run_today == 'true' && steps.date.outputs.hour == '10' && steps.date.outputs.minute == '45'
        env:
          INVERTER_TOKEN: ${{ secrets.INVERTER_TOKEN }}
        run: python inverter_control.py set-sbu

      - name: Read Status (Hourly)
        if: steps.check_day.outputs.run_today == 'true' && steps.date.outputs.minute == '00'
        env:
          INVERTER_TOKEN: ${{ secrets.INVERTER_TOKEN }}
        run: python inverter_control.py read-status
