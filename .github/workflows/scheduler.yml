name: Inverter Control Scheduler

on:
  workflow_dispatch:
    inputs:
      action_to_run:
        description: 'Select Command'
        required: true
        default: 'read-status'
        type: choice
        options:
          - read-status
          - set-solar
          - set-sbu
      ignore_date_skip:
        description: 'Override date restriction (23rd-26th)?'
        type: boolean
        default: true

  schedule:
    - cron: '10,20,30 23 * * *'  # Solar Logic
    - cron: '45 10 * * *'        # SBU Logic
    - cron: '0,15 11 * * *'      # SBU Logic
    - cron: '0 */2 * * *'        # Status Check

jobs:
  execute-command:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ” Resolve Context
        id: ctx
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "action=${{ github.event.inputs.action_to_run }}" >> $GITHUB_OUTPUT
            echo "force=${{ github.event.inputs.ignore_date_skip }}" >> $GITHUB_OUTPUT
          else
            echo "force=false" >> $GITHUB_OUTPUT
            CRON="${{ github.event.schedule }}"
            if [[ "$CRON" == "10,20,30 23 * * *" ]]; then
              echo "action=set-solar" >> $GITHUB_OUTPUT
            elif [[ "$CRON" == "45 10 * * *" || "$CRON" == "0,15 11 * * *" ]]; then
              echo "action=set-sbu" >> $GITHUB_OUTPUT
            else
              echo "action=read-status" >> $GITHUB_OUTPUT
            fi
          fi

      - name: ðŸ“… Date Check
        id: gate
        run: |
          DAY=$(TZ="Asia/Bangkok" date +'%d')
          ACTION="${{ steps.ctx.outputs.action }}"
          FORCE="${{ steps.ctx.outputs.force }}"
          
          if [[ "$ACTION" == "set-solar" && "$FORCE" == "false" && $DAY -ge 23 && $DAY -le 26 ]]; then
            echo "proceed=false" >> $GITHUB_OUTPUT
            echo "Skipping scheduled Solar task for date: $DAY"
          else
            echo "proceed=true" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.gate.outputs.proceed == 'true'
        uses: actions/checkout@v4

      - name: Setup Python
        if: steps.gate.outputs.proceed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run
        if: steps.gate.outputs.proceed == 'true'
        env:
          INVERTER_TOKEN: ${{ secrets.INVERTER_TOKEN }}
        run: |
          pip install requests
          python inverter_control.py ${{ steps.ctx.outputs.action }}