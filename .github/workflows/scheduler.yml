name: Inverter Control Scheduler

on:
  workflow_dispatch:
  schedule:
    # Solar Control Retries â€” run at 06:10, 06:20, 06:30 (Asia/Bangkok = UTC+7)
    # 06:10 BKK -> 23:10 UTC (previous day)
    - cron: '10,20,30 23 * * *'

    # SBU Control Retries: 17:45, 18:00, 18:15 (Bangkok) -> 10:45, 11:00, 11:15 (UTC)
    - cron: '45 10 * * *'
    - cron: '0,15 11 * * *'

    # Read Status: every 2 hours at minute 0 (UTC)
    - cron: '0 */2 * * *'

# Optional: default env values for retry/timeout knobs (override per-job if needed)
env:
  INVERTER_MAX_RETRIES: '5'
  INVERTER_BACKOFF_FACTOR: '2.0'
  INVERTER_REQUEST_TIMEOUT: '45'

jobs:
  # ===============================================================
  #  JOB 1: Set Inverter to SOLAR Mode (with retries)
  #  (SKIPS running on Thailand dates 23-26)
  # ===============================================================
  set-solar-mode:
    name: 'â˜€ï¸ Set Solar Mode'
    # Allow running either on schedule or when manually triggered via workflow_dispatch
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '10,20,30 23 * * *'
    runs-on: ubuntu-latest
    env:
      INVERTER_MAX_RETRIES: ${{ env.INVERTER_MAX_RETRIES }}
      INVERTER_BACKOFF_FACTOR: ${{ env.INVERTER_BACKOFF_FACTOR }}
      INVERTER_REQUEST_TIMEOUT: ${{ env.INVERTER_REQUEST_TIMEOUT }}
      INVERTER_TOKEN: ${{ secrets.INVERTER_TOKEN }}
    steps:
      - name: Check if today is an automation day (Thailand local date)
        id: check_day
        run: |
          # Evaluate the day using Asia/Bangkok timezone to apply skip correctly on local dates.
          day=$(TZ="Asia/Bangkok" date +'%d')
          echo "Thailand local day: $day"
          if [[ $day -ge 23 && $day -le 26 ]]; then
            echo "Automation is SKIPPED today (Thailand date $day is between 23-26)."
            echo "run_today=false" >> $GITHUB_OUTPUT
          else
            echo "Automation is ENABLED today (Thailand date $day)."
            echo "run_today=true" >> $GITHUB_OUTPUT
          fi

      - name: Checkout code
        if: steps.check_day.outputs.run_today == 'true'
        uses: actions/checkout@v4

      - name: Set up Python
        if: steps.check_day.outputs.run_today == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run Solar Command
        if: steps.check_day.outputs.run_today == 'true'
        run: |
          python -m pip install --upgrade pip requests
          # Diagnostic: print Bangkok-local timestamp
          python - <<'PY'
from datetime import datetime
import zoneinfo
tz = zoneinfo.ZoneInfo("Asia/Bangkok")
print("Bangkok local time at run:", datetime.now(tz).isoformat())
PY
          python inverter_control.py set-solar

  # ===============================================================
  #  JOB 2: Set Inverter to SBU Mode (with retries)
  #  (Runs EVERY scheduled time and also on manual dispatch)
  # ===============================================================
  set-sbu-mode:
    name: 'ðŸ”‹ Set SBU Mode'
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '45 10 * * *' || github.event.schedule == '0,15 11 * * *'
    runs-on: ubuntu-latest
    env:
      INVERTER_MAX_RETRIES: ${{ env.INVERTER_MAX_RETRIES }}
      INVERTER_BACKOFF_FACTOR: ${{ env.INVERTER_BACKOFF_FACTOR }}
      INVERTER_REQUEST_TIMEOUT: ${{ env.INVERTER_REQUEST_TIMEOUT }}
      INVERTER_TOKEN: ${{ secrets.INVERTER_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run SBU Command
        run: |
          python -m pip install --upgrade pip requests
          python inverter_control.py set-sbu

  # ===============================================================
  #  JOB 3: Read Inverter Status (every 2 hours)
  #  (Runs EVERY day, every 2 hours, and on manual dispatch)
  # ===============================================================
  read-status:
    name: 'ðŸ“Š Read Status'
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '0 */2 * * *'
    runs-on: ubuntu-latest
    env:
      INVERTER_REQUEST_TIMEOUT: ${{ env.INVERTER_REQUEST_TIMEOUT }}
      INVERTER_TOKEN: ${{ secrets.INVERTER_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run Read Status Command
        run: |
          python -m pip install --upgrade pip requests
          python inverter_control.py read-status
